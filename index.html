<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Habitos Atomicos v104.2 - Fix</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        /* --- TIPOGRAF√çA --- */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=Lora:ital,wght@0,400;0,500;0,600;1,400&family=Caveat:wght@400;700&display=swap');

        :root {
            --paper-bg: #FFFFFF;         
            --ink-primary: #0F172A;      
            --ink-secondary: #475569;    
            --accent-vibrant: #6366F1;   
            --accent-green: #10B981;     
            --accent-gold: #F59E0B;      
            --accent-danger: #EF4444;    
            --line-soft: #F1F5F9;
            --weekend-bg: #E2E8F0;      
            --holiday-bg: #FEE2E2;      
            --metal-bronze: #D97706;
            --metal-silver: #64748B;
            --metal-gold: #F59E0B;
            --metal-super: #4F46E5;      
            --shadow-pop: 0 20px 25px -5px rgba(0,0,0,0.15), 0 8px 10px -6px rgba(0,0,0,0.1);
            --champion-success: rgba(16, 185, 129, 0.12); 
        }

        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            background-color: #CBD5E1;
            background-image: radial-gradient(var(--accent-vibrant) 0.5px, transparent 0.5px);
            background-size: 40px 40px;
            color: var(--ink-primary);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            padding: 0;
            -webkit-font-smoothing: antialiased;
        }

        /* --- CONTENEDOR ADAPTATIVO --- */
        .page-container {
            width: 100%;
            max-width: 900px;
            background: var(--paper-bg);
            box-shadow: var(--shadow-pop);
            display: flex; 
            flex-direction: column; 
            min-height: 100vh;
            position: relative;
            padding: 1rem;
        }

        @media (min-width: 768px) {
            .page-container {
                margin: 2rem;
                min-height: 297mm;
                border-radius: 12px;
                padding: 14mm 16mm;
                border: 2px solid var(--ink-primary);
            }
        }

        h1 { font-weight: 900; font-size: 1.5rem; letter-spacing: -0.04em; color: var(--ink-primary); }
        .subtitle { font-family: 'Inter', sans-serif; font-size: 0.6rem; font-weight: 800; text-transform: uppercase; letter-spacing: 0.2em; color: var(--accent-vibrant); }

        /* --- MATRIZ MOBILE FRIENDLY --- */
        .tracker-container { 
            display: flex; 
            flex-direction: column; 
            flex-grow: 1; 
            margin-top: 1.5rem; 
            overflow: hidden; 
            padding-bottom: 80px; 
        }
        
        .table-wrapper { 
            flex-grow: 1; 
            overflow: auto; 
            border: 1px solid var(--ink-primary); 
            background: white; 
            border-radius: 8px; 
            position: relative;
        }

        .tracker-table { width: 100%; border-collapse: collapse; table-layout: fixed; }
        .tracker-table th { 
            font-size: 0.5rem; font-weight: 900; text-align: center; vertical-align: bottom; padding: 8px 2px;
            height: 50px; border-bottom: 2px solid var(--ink-primary); color: white; background: var(--ink-primary); 
            position: sticky; top: 0; z-index: 30; cursor: pointer;
        }
        
        .tracker-table td { height: 35px; border-bottom: 1px solid var(--line-soft); border-right: 1px solid var(--line-soft); text-align: center; position: relative; }
        
        .day-col { 
            font-weight: 900; font-size: 0.75rem; width: 35px !important; 
            background: #F1F5F9; color: var(--ink-primary); 
            border-right: 2px solid var(--ink-primary) !important;
            position: sticky; left: 0; z-index: 20;
        }

        .weekend-row td:not(.day-col):not(.trophy-col) { background-color: var(--weekend-bg); }
        .holiday-row td:not(.day-col):not(.trophy-col) { background-color: var(--holiday-bg); }
        .holiday-row .day-col { color: var(--accent-danger) !important; background-color: #FEE2E2; }

        .mood-col { width: 55px !important; border-right: 2px solid var(--ink-primary) !important; }
        
        .mood-selector { cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; }
        .mood-emoji { font-size: 1.2rem; line-height: 1; }
        .mood-label { font-size: 0.4rem; font-weight: 900; text-transform: uppercase; color: var(--ink-secondary); margin-top: 2px; }

        .tracker-cell { cursor: pointer; position: relative; min-width: 45px; }
        .tracker-cell.completed::after {
            content: '\2605'; 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; align-items: center; justify-content: center;
            font-size: 18px; z-index: 10; animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .tracker-cell.completed.streak-7::after { font-size: 28px !important; z-index: 15; transform: scale(1.15); filter: drop-shadow(0 0 8px white); }

        .bronze-mark.completed::after { color: var(--metal-bronze); }
        .silver-mark.completed::after { color: var(--metal-silver); }
        .gold-mark.completed::after { color: var(--metal-gold); }
        .super-gold-mark.completed::after { color: var(--metal-super); filter: drop-shadow(0 0 5px var(--accent-vibrant)); }

        tr.row-full-complete td:not(.day-col):not(.trophy-col) { background-color: var(--champion-success) !important; }
        .trophy-col { width: 45px !important; border-left: 2px solid var(--ink-primary); background: #F8FAFC; }
        .trophy-display { font-size: 1.2rem; display: flex; align-items: center; justify-content: center; height: 100%; }

        /* --- NAVEGACI√ìN M√ìVIL --- */
        .mobile-nav {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            display: flex; justify-content: space-around;
            padding: 0.75rem 0.5rem;
            border-top: 1px solid var(--line-soft);
            z-index: 100;
            box-shadow: 0 -4px 10px rgba(0,0,0,0.05);
        }

        .nav-item {
            display: flex; flex-direction: column; align-items: center;
            gap: 4px; color: var(--ink-secondary);
            font-size: 0.6rem; font-weight: 800; text-transform: uppercase;
        }
        .nav-item.active { color: var(--accent-vibrant); }
        .nav-item i { font-size: 1.2rem; }

        @media (min-width: 768px) {
            .mobile-nav { display: none; }
            .tracker-container { padding-bottom: 0; }
        }

        /* MODAL FULLSCREEN EN M√ìVIL */
        @media (max-width: 767px) {
            .modal-card { width: 100% !important; height: 100% !important; max-width: none !important; border-radius: 0 !important; border: none !important; }
            .tab-btn { padding: 10px 12px; font-size: 0.6rem; }
        }

        #toast-notification { 
            visibility: hidden; min-width: 280px; background-color: var(--ink-primary); color: white; text-align: center; 
            padding: 16px; position: fixed; z-index: 2000; left: 50%; bottom: 100px; transform: translateX(-50%); 
            font-size: 0.8rem; border-radius: 10px; opacity: 0; transition: 0.4s; font-weight: 700;
            border-left: 8px solid var(--accent-gold); box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        #toast-notification.show { visibility: visible; opacity: 1; transform: translateX(-50%) translateY(0); }
        #toast-notification.alert-mode { border-left-color: var(--accent-danger); }
        #toast-notification.success-mode { border-left-color: var(--accent-green); }

        .loading-ia { display: flex; align-items: center; justify-content: center; gap: 10px; padding: 20px; font-weight: 800; color: var(--accent-gold); }

        @keyframes popIn { from { transform: scale(0) rotate(-45deg); opacity: 0; } to { transform: scale(1) rotate(0); opacity: 1; } }
        .no-print { user-select: none; }
    </style>
</head>
<body>

    <!-- BOTONES ESCRITORIO -->
    <div class="no-print hidden md:flex fixed top-6 left-6 z-50 gap-3">
        <button onclick="downloadHTML()" class="p-2 bg-white rounded-full shadow-md border border-slate-200" title="Guardar"><i class="fas fa-save text-indigo-600"></i></button>
        <button onclick="exportCSV()" class="p-2 bg-white rounded-full shadow-md border border-slate-200" title="Exportar CSV"><i class="fas fa-file-csv text-green-600"></i></button>
    </div>

    <!-- NAVEGACI√ìN M√ìVIL -->
    <nav class="mobile-nav no-print">
        <button onclick="openMealSelector()" class="nav-item active"><i class="fas fa-utensils"></i><span>Chef</span></button>
        <button onclick="openWorkoutSelector()" class="nav-item"><i class="fas fa-dumbbell"></i><span>Gym</span></button>
        <button onclick="openSettings('tab-profile')" class="nav-item"><i class="fas fa-cog"></i><span>Ajustes</span></button>
    </nav>

    <div class="page-container">
        <header class="flex justify-between items-center border-b-2 border-slate-900 pb-4 mb-2">
            <div class="flex items-center gap-3">
                <div id="display-avatar" class="w-10 h-10 md:w-14 md:h-14 rounded-full border-2 border-slate-900 flex items-center justify-center text-xl md:text-3xl bg-white shadow-sm"><i class="fas fa-brain"></i></div>
                <div>
                    <h1 id="display-name">Enero 2026</h1>
                    <p class="subtitle italic">Habitos Atomicos</p>
                </div>
            </div>
            
            <div class="hidden md:flex gap-3 no-print">
                <button onclick="openMealSelector()" class="p-2 border-2 border-slate-900 rounded-lg text-xs font-black bg-indigo-50"><i class="fas fa-utensils text-indigo-600"></i> NEURO-CHEF ‚ú®</button>
                <button onclick="openSettings('tab-profile')" class="p-2 border-2 border-slate-900 rounded-lg"><i class="fas fa-cog"></i></button>
            </div>
        </header>

        <div class="tracker-container">
            <div class="table-wrapper" id="table-scroll-area">
                <table class="tracker-table" id="tracker-table">
                    <thead id="tracker-head"></thead>
                    <tbody id="tracker-body"></tbody>
                </table>
            </div>
        </div>

        <footer class="mt-4 flex justify-between items-center text-[0.55rem] font-black text-slate-900 uppercase tracking-widest italic opacity-40">
            <span>Granada ‚Ä¢ ES</span>
            <span>Neuro-Chef v104.2</span>
        </footer>
    </div>

    <!-- MODAL -->
    <div id="main-modal" class="no-print fixed inset-0 hidden z-[200] flex items-center justify-center p-0 md:p-4 bg-slate-900/60 backdrop-blur-sm">
        <div class="modal-card p-6 w-full transform transition-all scale-100 flex flex-col">
            <button onclick="closeModal()" class="absolute top-4 right-4 text-slate-300 hover:text-slate-600 transition z-50"><i class="fas fa-times fa-lg"></i></button>
            
            <div class="modal-tabs overflow-x-auto whitespace-nowrap" id="modal-tabs-header">
                <div id="btn-tab-profile" class="tab-btn active" onclick="switchTab('tab-profile')">PERFIL</div>
                <div id="btn-tab-habits" class="tab-btn" onclick="switchTab('tab-habits')">H√ÅBITOS</div>
                <div id="btn-tab-meals" class="tab-btn" onclick="switchTab('tab-meals')">CHEF IA</div>
                <div id="btn-tab-workouts" class="tab-btn" onclick="switchTab('tab-workouts')">GIMNASIO</div>
                <div id="btn-tab-system" class="tab-btn" onclick="switchTab('tab-system')">SISTEMA</div>
            </div>
            
            <div id="ia-result" class="hidden mb-6 p-4 bg-slate-900 text-white italic text-sm rounded-lg border-l-4 border-amber-500 shadow-xl overflow-y-auto">
                 <button onclick="document.getElementById('ia-result').classList.add('hidden')" class="absolute top-2 right-2 text-white opacity-50 hover:opacity-100 text-xs">‚úï</button>
                 <div id="ia-content"></div>
            </div>

            <!-- SELECTOR GIMNASIO -->
            <div id="gym-day-selector" class="tab-content hidden text-center flex-grow">
                <h4 class="font-black text-indigo-600 uppercase text-xs mb-4 italic">Registro T√°ctico</h4>
                <div class="grid grid-cols-1 gap-2 mb-4" id="gym-routine-grid"></div>
                <button onclick="setGymDay(6)" class="w-full py-4 bg-slate-100 text-slate-800 text-xs font-black uppercase border-2 border-indigo-600 rounded mb-3">üåä Descanso (D)</button>
                <button onclick="clearGymCheck()" class="w-full py-2 text-red-500 font-bold text-xs">Borrar Registro</button>
            </div>
            
            <div id="tab-profile" class="tab-content flex-grow">
                <div class="flex flex-col gap-4">
                    <input type="text" id="p-name" placeholder="Tu Nombre" class="border-b-2 border-slate-900 w-full p-2 font-black outline-none text-lg bg-transparent">
                    <div class="grid grid-cols-2 gap-4">
                        <input type="number" id="p-age" placeholder="Edad" class="border-b border-slate-200 p-2 text-sm">
                        <input type="number" id="p-weight" placeholder="kg" class="border-b border-slate-200 p-2 text-sm">
                    </div>
                </div>
            </div>

            <div id="tab-habits" class="tab-content hidden flex-grow">
                <div id="habits-list-ui" class="max-h-40 overflow-y-auto border border-slate-100 rounded mb-4 text-xs"></div>
                <div class="bg-indigo-50 p-3 rounded-lg">
                    <input type="text" id="h-name" placeholder="Nuevo H√°bito" class="border p-2 text-xs w-full rounded mb-2 uppercase font-bold">
                    <input type="text" id="h-tip" placeholder="Leyenda / Explicaci√≥n" class="border p-2 text-[10px] w-full rounded mb-2 outline-none">
                    <button onclick="addHabitAction()" class="w-full py-2 bg-indigo-600 text-white rounded font-bold text-xs">A√±adir</button>
                </div>
            </div>

            <div id="tab-meals" class="tab-content hidden text-center flex-grow">
                <p class="text-xs font-black text-slate-400 uppercase mb-4 tracking-widest">Sugerencias Nutricionales</p>
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="suggestMeal('Desayuno')" class="btn-option"><strong>‚òï Desayuno Fit ‚ú®</strong><span>Bajo en grasa</span></button>
                    <button onclick="suggestMeal('Almuerzo')" class="btn-option"><strong>ü•ó Almuerzo Fit ‚ú®</strong><span>Alto en prote√≠na</span></button>
                    <button onclick="suggestMeal('Cena')" class="btn-option"><strong>üç≤ Cena Fit ‚ú®</strong><span>Rica en verduras</span></button>
                    <button onclick="suggestMeal('Snack')" class="btn-option"><strong>ü•ú Snack Fit ‚ú®</strong><span>Ligero y sano</span></button>
                    <button onclick="suggestMeal('Placer Culpable')" class="btn-option bg-rose-50 border-rose-200 col-span-2">
                        <div class="flex justify-between items-center w-full">
                            <strong>üçï PLACER CULPABLE ‚ú®</strong>
                            <span class="text-[10px] text-rose-600 font-black">BURGERS, PIZZA, FRITOS...</span>
                        </div>
                    </button>
                </div>
            </div>

            <div id="tab-workouts" class="tab-content hidden flex-grow">
                <p class="text-[10px] font-black text-slate-400 uppercase mb-4 text-center tracking-widest italic">Split Semanal</p>
                <div id="gym-editor-list" class="max-h-80 overflow-y-auto"></div>
            </div>

            <div id="tab-system" class="tab-content hidden text-center flex-grow">
                <input type="password" id="api-key-input" class="border p-3 rounded w-full mb-6 font-mono text-xs" placeholder="API Key Gemini">
                <button onclick="confirmReset()" class="w-full py-3 bg-red-600 text-white rounded font-bold text-xs">BORRAR TODOS LOS DATOS</button>
            </div>

            <div class="mt-auto flex justify-between items-center border-t pt-4" id="modal-footer">
                <button onclick="closeModal()" class="text-xs font-black text-slate-400">VOLVER</button>
                <button id="btn-save-all" onclick="saveAllSettings()" class="py-3 px-8 bg-slate-900 text-white rounded-lg font-black text-xs">GUARDAR TODO</button>
            </div>
        </div>
    </div>

    <div id="toast-notification"></div>

    <script>
        const apiKeyDefault = ""; 
        const daysInMonth = 31;
        const moodConfig = [{icon:'üòê',label:'Normal'}, {icon:'üôÇ',label:'Bien'}, {icon:'üòÅ',label:'Genial'}, {icon:'ü§©',label:'Flow'}, {icon:'üôÅ',label:'Bajo'}, {icon:'üò¢',label:'Triste'}, {icon:'üò≠',label:'Muy Triste'}, {icon:'üò´',label:'Estresado'}];
        const routineLabels = { 1: "T1", 2: "E1", 3: "P", 4: "T2", 5: "E2", 6: "D" };
        const nationalHolidays = [1, 6];

        let habitsConfig = [];
        let profileData = {name:'', age:'', height:'183', weight: '84', avatar:'fa-brain'};
        let myRoutines = [];
        let trackerBody, trackerHead;
        let activeGymDayOfMonth = null;

        const playSfx = (f,t,d,v) => { try{ const ac=new(window.AudioContext||window.webkitAudioContext)(); const o=ac.createOscillator(); const g=ac.createGain(); o.type=t; o.frequency.setValueAtTime(f,ac.currentTime); g.gain.setValueAtTime(v,ac.currentTime); g.gain.exponentialRampToValueAtTime(0.001,ac.currentTime+d); o.connect(g); g.connect(ac.destination); o.start(); o.stop(ac.currentTime+d+0.1); }catch(e){} };
        const playPop=()=>playSfx(400,'sine',0.1,0.1); 
        const playVictory=()=>{ [523,659,783,1046,1318].forEach((f,i)=>setTimeout(()=>playSfx(f,'sine',0.8,0.1),i*100)); };

        // --- GEMINI API INTEGRATION ---
        async function callGemini(prompt, systemPrompt) {
            const userKey = localStorage.getItem('gemini_api_key') || apiKeyDefault;
            const apiEndpoint = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${userKey}`;
            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] }
            };
            const maxRetries = 5;
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(apiEndpoint, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    if (response.ok) { const result = await response.json(); return result.candidates?.[0]?.content?.parts?.[0]?.text; }
                } catch (error) {
                    const delay = Math.pow(2, i) * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
            throw new Error("API Offline");
        }

        async function displayIA(text) {
            const iaBox = document.getElementById('ia-result');
            const iaContent = document.getElementById('ia-content');
            iaBox.classList.remove('hidden');
            iaContent.innerHTML = text.replace(/\n/g, '<br>');
        }

        async function suggestMeal(type) {
            displayIA('<div class="loading-ia"><i class="fas fa-utensils fa-spin"></i> Consultando al Neuro-Chef para Granada...</div>');
            const todayDay = new Date().getDate();
            const moodEmoji = document.getElementById(`mood-row-${todayDay}`)?.innerText || "üòê";
            
            let constraints = (type === "Placer Culpable") 
                ? "Regla: Es un capricho. Puede incluir Pizzas, Hamburguesas, Fritos." 
                : "Regla Estricta: Alimentaci√≥n Fit. Baja en grasa, rica en prote√≠nas, con abundantes verduras frescas.";

            const prompt = `Usuario: ${profileData.name}, 38 a√±os, 84kg, 183cm. Ubicaci√≥n: Granada. Tipo: ${type}. Mood actual: ${moodEmoji}. Ingredientes: Mercadona. ${constraints} S√© breve.`;

            try { 
                const res = await callGemini(prompt, "Eres un Chef especializado en neuro-gastronom√≠a."); 
                displayIA(res); 
            } catch (err) { 
                displayIA("‚ö†Ô∏è Error al conectar con el Chef IA."); 
            }
        }

        // --- CORE LOGIC ---
        function init() {
            trackerBody = document.getElementById('tracker-body');
            trackerHead = document.getElementById('tracker-head');
            loadConfig(); renderHabitsUI(); renderRightPage(); updateProfileDisplay(); renderGymRoutinesUI();
            setTimeout(checkMoodAlert, 1500);
            setTimeout(checkInactivityAlerts, 2000);
        }

        function renderRightPage() {
            if (!trackerHead || !trackerBody) return;
            trackerHead.innerHTML = `<tr><th class="day-col">#</th><th class="mood-col">MOOD</th>${habitsConfig.map(h => `<th><i class="fas ${h.icon}"></i><br>${h.name}</th>`).join('')}<th class="trophy-col">üèÜ</th></tr>`;
            trackerBody.innerHTML = '';
            const saved = JSON.parse(localStorage.getItem('planner_data_v104_1') || '{}');
            const habitChecksSoFar = {}; habitsConfig.forEach(h => habitChecksSoFar[h.id] = 0);
            let totalPerfectDays = 0;

            for(let i=1; i<=daysInMonth; i++) {
                const tr = document.createElement('tr'); tr.id = `row-${i}`;
                const date = new Date(2026, 0, i);
                if(date.getDay()===0||date.getDay()===6) tr.classList.add('weekend-row');
                if(nationalHolidays.includes(i)) tr.classList.add('holiday-row');
                
                let html = `<td class="day-col">${i}</td>`;
                const currentMood = saved.moods ? saved.moods[i] : null;
                let moodHtml = currentMood ? `<span class="mood-emoji">${currentMood}</span><span class="mood-label">${moodConfig.find(m=>m.icon===currentMood)?.label || ''}</span>` : `¬∑`;
                html += `<td class="mood-col" id="mood-row-${i}" onclick="cycleMood(${i})"><div class="mood-selector">${moodHtml}</div></td>`;

                let rowIsComplete = true; let habitsMarkedCount = 0;
                habitsConfig.forEach(h => {
                    const checkValue = saved.habits && saved.habits[`${i}-${h.id}`];
                    const isDone = !!checkValue;
                    if (isDone) { habitChecksSoFar[h.id]++; habitsMarkedCount++; } else { rowIsComplete = false; }
                    let streak = 0; if (isDone) { for (let d = i; d > 0; d--) { if (saved.habits && saved.habits[`${d}-${h.id}`]) streak++; else break; } }
                    const isStreakMilestone = isDone && streak > 0 && streak % 7 === 0;
                    const metalClass = getMetalClass(habitChecksSoFar[h.id]);
                    const isGym = h.id.toLowerCase().includes('gym') || h.icon.includes('dumbbell');
                    const routineValue = (isGym && isDone && typeof checkValue === 'number') ? checkValue : null;

                    html += `<td class="tracker-cell ${metalClass} ${isDone?'completed':''} ${isGym?'gym-check':''} ${isStreakMilestone?'streak-7':''}" data-routine-label="${routineValue ? routineLabels[routineValue] : ''}" data-day="${i}" data-habit="${h.id}" onclick="toggleCell(this, '${h.id}', ${i}, '${h.icon}')"></td>`;
                });
                
                let trophyHtml = '';
                if (rowIsComplete && habitsConfig.length > 0) {
                    totalPerfectDays++;
                    trophyHtml = `<span class="trophy-display ${getTrophyClass(totalPerfectDays)}">üèÜ</span>`;
                    tr.classList.add('row-full-complete');
                } else if (habitsMarkedCount > 0) {
                    trophyHtml = `<span class="trophy-display medal-display text-amber-800 opacity-20">üèÖ</span>`;
                }
                html += `<td class="trophy-col">${trophyHtml}</td>`;
                tr.innerHTML = html; trackerBody.appendChild(tr);
            }
        }

        function toggleCell(cell, hId, day, hIcon) {
            const isGym = hId.toLowerCase().includes('gym') || hIcon.includes('dumbbell');
            if (isGym) {
                activeGymDayOfMonth = day;
                document.getElementById('main-modal').classList.remove('hidden');
                document.getElementById('modal-tabs-header').classList.add('hidden');
                document.getElementById('btn-save-all').classList.add('hidden');
                switchTab('gym-day-selector');
            } else {
                cell.classList.toggle('completed');
                const isNowCompleted = cell.classList.contains('completed');
                if(isNowCompleted) { playSfx(600, 'triangle', 0.1, 0.05); checkStreakCongratulation(hId, day); } 
                else playSfx(140, 'triangle', 0.15, 0.15);
                saveMatrixState(); renderRightPage();
                const row = document.getElementById(`row-${day}`);
                if(row && row.classList.contains('row-full-complete') && isNowCompleted) playVictory();
            }
        }

        function setGymDay(dayIndex) {
            const saved = JSON.parse(localStorage.getItem('planner_data_v104_1') || '{}');
            saved.habits = saved.habits || {};
            const gymHabit = habitsConfig.find(h => h.id.toLowerCase().includes('gym') || h.icon.includes('dumbbell'));
            if(!gymHabit) return;
            saved.habits[`${activeGymDayOfMonth}-${gymHabit.id}`] = dayIndex;
            localStorage.setItem('planner_data_v104_1', JSON.stringify(saved));
            playSfx(600, 'triangle', 0.1, 0.05);
            closeModal(); renderRightPage();
            const row = document.getElementById(`row-${activeGymDayOfMonth}`);
            if(row && row.classList.contains('row-full-complete')) playVictory();
        }

        function clearGymCheck() {
            const saved = JSON.parse(localStorage.getItem('planner_data_v104_1') || '{}');
            const gymHabit = habitsConfig.find(h => h.id.toLowerCase().includes('gym') || h.icon.includes('dumbbell'));
            if(gymHabit && saved.habits) delete saved.habits[`${activeGymDayOfMonth}-${gymHabit.id}`];
            localStorage.setItem('planner_data_v104_1', JSON.stringify(saved));
            closeModal(); renderRightPage();
        }

        function cycleMood(day) {
            const saved = JSON.parse(localStorage.getItem('planner_data_v104_1') || '{}');
            saved.moods = saved.moods || {};
            const current = saved.moods[day] || 'üòê';
            const idx = moodConfig.findIndex(m => m.icon === current);
            saved.moods[day] = moodConfig[(idx + 1) % moodConfig.length].icon;
            localStorage.setItem('planner_data_v104_1', JSON.stringify(saved));
            playPop(); renderRightPage(); checkMoodAlert();
        }

        function checkMoodAlert() {
            const saved = JSON.parse(localStorage.getItem('planner_data_v104_1') || '{}');
            const moods = saved.moods || {};
            const negativeIcons = ['üôÅ', 'üò¢', 'üò≠', 'üò´']; 
            const alertLog = JSON.parse(localStorage.getItem('planner_mood_alert_v104_1') || '{}');
            alertLog.notifiedStreaks = alertLog.notifiedStreaks || [];
            for (let i = 4; i <= daysInMonth; i++) {
                let negativeStreakCount = 0;
                for (let j = 0; j < 4; j++) { if (moods[i-j] && negativeIcons.includes(moods[i-j])) negativeStreakCount++; else break; }
                if (negativeStreakCount === 4 && !alertLog.notifiedStreaks.includes(i)) {
                    setTimeout(() => { showToast("Llevas unos d√≠as de √°nimo bajo. Prioriza el descanso. ¬°Mucho √°nimo!", "alert"); playSfx(300, 'sine', 0.8, 0.1); }, 1000);
                    alertLog.notifiedStreaks.push(i); localStorage.setItem('planner_mood_alert_v104_1', JSON.stringify(alertLog));
                    return;
                }
            }
        }

        function checkInactivityAlerts() {
            const todayDay = new Date().getDate();
            if (![7, 14, 21, 28, 31].includes(todayDay)) return;
            const saved = JSON.parse(localStorage.getItem('planner_data_v104_1') || '{}');
            const alertLog = JSON.parse(localStorage.getItem('planner_alerts_v104_1') || '{}');
            if (alertLog.lastDate === todayDay) return;
            
            let alertsShown = 0;
            habitsConfig.forEach(h => {
                let empty = 0;
                for (let d = todayDay - 6; d <= todayDay; d++) if (d > 0 && !saved.habits[`${d}-${h.id}`]) empty++;
                if (empty >= 5) {
                     setTimeout(() => { showToast(`Esta semana no has hecho ${h.name}, a√∫n est√°s a tiempo. ¬°√Ånimo!`, "alert"); }, alertsShown * 4000);
                     alertsShown++;
                }
            });
            if (alertsShown > 0) { alertLog.lastDate = todayDay; localStorage.setItem('planner_alerts_v104_1', JSON.stringify(alertLog)); }
        }

        function checkStreakCongratulation(hId, day) {
            const saved = JSON.parse(localStorage.getItem('planner_data_v104_1') || '{}');
            let streak = 0; for (let d = day; d > 0; d--) if (saved.habits && saved.habits[`${d}-${hId}`]) streak++; else break;
            if (streak === 7) showToast(`¬°Racha de 7 d√≠as en ${hId.toUpperCase()}!`, "success");
        }

        function saveMatrixState() {
            const saved = JSON.parse(localStorage.getItem('planner_data_v104_1') || '{}');
            const habits = saved.habits || {};
            habitsConfig.forEach(h => {
                if (!(h.id.toLowerCase().includes('gym'))) {
                    for (let i = 1; i <= daysInMonth; i++) {
                        const cell = document.querySelector(`.tracker-cell[data-day="${i}"][data-habit="${h.id}"]`);
                        if (cell && cell.classList.contains('completed')) habits[`${i}-${h.id}`] = true;
                        else if (cell) delete habits[`${i}-${h.id}`];
                    }
                }
            });
            saved.habits = habits; localStorage.setItem('planner_data_v104_1', JSON.stringify(saved));
        }

        function loadConfig() {
            habitsConfig = JSON.parse(localStorage.getItem('planner_config_v104_1')) || [
                {id:'piano',name:'Piano',icon:'fa-music', tip:'Practicar 30 min'},
                {id:'gym',name:'Gym',icon:'fa-dumbbell', tip:'Rutina split'},
                {id:'leer',name:'Lectura',icon:'fa-book', tip:'15 min lectura'}
            ];
            profileData = JSON.parse(localStorage.getItem('planner_profile_v104_1')) || {name:'Neuropsic√≥logo', age:'38', height:'183', weight:'84', avatar:'fa-brain'};
            myRoutines = JSON.parse(localStorage.getItem('planner_routines_v104_1')) || [{ id: 1, name: "Tir√≥n 1", exercises: "Remo" }, { id: 2, name: "Empuje 1", exercises: "Press" }, { id: 3, name: "Pierna", exercises: "Sentadilla" }, { id: 4, name: "Tir√≥n 2", exercises: "Dominadas" }, { id: 5, name: "Empuje 2", exercises: "Militar" }];
        }

        function saveAllSettings() {
            localStorage.setItem('gemini_api_key', document.getElementById('api-key-input').value.trim());
            profileData.name = document.getElementById('p-name').value;
            profileData.age = document.getElementById('p-age').value;
            profileData.weight = document.getElementById('p-weight').value;
            localStorage.setItem('planner_profile_v104_1', JSON.stringify(profileData));
            localStorage.setItem('planner_config_v104_1', JSON.stringify(habitsConfig));
            localStorage.setItem('planner_routines_v104_1', JSON.stringify(myRoutines));
            saveMatrixState(); closeModal(); init();
        }

        function openSettings(tab) { document.getElementById('main-modal').classList.remove('hidden'); switchTab(tab || 'tab-profile'); }
        function openMealSelector() { document.getElementById('main-modal').classList.remove('hidden'); switchTab('tab-meals'); }
        function openWorkoutSelector() { document.getElementById('main-modal').classList.remove('hidden'); switchTab('tab-workouts'); }
        function closeModal() { document.getElementById('main-modal').classList.add('hidden'); document.getElementById('modal-tabs-header').classList.remove('hidden'); document.getElementById('btn-save-all').classList.remove('hidden'); }
        function switchTab(id, isAgent = false) {
            document.querySelectorAll('.tab-content, #ia-result').forEach(x => x.classList.add('hidden'));
            const t = document.getElementById(id); if(t) t.classList.remove('hidden');
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            const btn = document.getElementById('btn-'+id); if(btn) btn.classList.add('active');
            if (id === 'gym-day-selector') { document.getElementById('modal-tabs-header').classList.add('hidden'); document.getElementById('btn-save-all').classList.add('hidden'); }
            else { document.getElementById('modal-tabs-header').classList.remove('hidden'); document.getElementById('btn-save-all').classList.remove('hidden'); }
        }
        function renderGymRoutinesUI() {
            document.getElementById('gym-editor-list').innerHTML = myRoutines.map((r, idx) => `<div class="mb-4 bg-slate-50 p-3 rounded-lg"><input type="text" value="${r.name}" onchange="updateRoutineData(${idx}, 'name', this.value)" class="border-b font-bold w-full mb-1 outline-none text-xs"><textarea rows="2" onchange="updateRoutineData(${idx}, 'exercises', this.value)" class="text-[10px] w-full bg-transparent">${r.exercises}</textarea></div>`).join('');
            document.getElementById('gym-routine-grid').innerHTML = myRoutines.map(r => `<button onclick="setGymDay(${r.id})" class="btn-option"><strong>D√≠a ${r.id}: ${r.name}</strong></button>`).join('');
        }
        function updateRoutineData(index, field, value) { myRoutines[index][field] = value; }
        function showToast(m, mode = "") { const t=document.getElementById('toast-notification'); t.innerText=m; t.classList.remove('alert-mode', 'success-mode'); if(mode) t.classList.add(mode+'-mode'); t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),6000); }
        function getMetalClass(count) { if (count <= 7) return 'bronze-mark'; if (count <= 14) return 'silver-mark'; if (count <= 21) return 'gold-mark'; return 'super-gold-mark'; }
        function getTrophyClass(count) { if (count <= 7) return 'trophy-gold'; if (count <= 14) return 'trophy-silver'; if (count <= 21) return 'trophy-gold'; return 'trophy-super'; }
        function downloadHTML() { document.querySelectorAll('input, textarea').forEach(i => i.setAttribute('value', i.value)); const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob(["<!DOCTYPE html>\n"+document.documentElement.outerHTML], {type:'text/html'})); a.download = 'Habitos_Atomicos_v104_2.html'; a.click(); }
        function exportCSV() { let csv = "D√≠a,Mood"; habitsConfig.forEach(h=>csv+=`,${h.name}`); csv+="\n"; const saved = JSON.parse(localStorage.getItem('planner_data_v104_1') || '{}'); for (let i = 1; i <= daysInMonth; i++) { csv += `${i},${saved.moods ? saved.moods[i] : ''}`; habitsConfig.forEach(h=>csv+=`,${saved.habits&&saved.habits[i+'-'+h.id]?1:0}`); csv+="\n"; } const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' }); const link = document.createElement("a"); link.href = URL.createObjectURL(blob); link.download = `Habitos_v104.csv`; link.click(); }
        function confirmReset() { if(confirm("¬øBORRAR TODO?")) { localStorage.clear(); location.reload(); } }
        function renderHabitsUI() { document.getElementById('habits-list-ui').innerHTML = habitsConfig.map((h,i) => `<div class="flex justify-between items-center bg-white p-2 mb-1 border-b rounded"><span>${h.name}</span><button onclick="remHabit(${i})" class="text-red-400 font-bold px-2">‚úï</button></div>`).join(''); }
        function addHabitAction() { const n = document.getElementById('h-name').value.toUpperCase().trim(); const t = document.getElementById('h-tip').value.trim(); if(!n) return; habitsConfig.push({id: n.toLowerCase().replace(/\s/g,''), name: n, icon: 'fa-star', tip: t}); renderHabitsUI(); }
        function remHabit(i) { habitsConfig.splice(i,1); renderHabitsUI(); }
        function updateProfileDisplay() { 
            const nameEl = document.getElementById('display-name');
            if (nameEl) nameEl.innerText = profileData.name || "Enero 2026"; 
        }

        window.onload = init;
    </script>
</body>
</html>
